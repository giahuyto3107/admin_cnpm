<!DOCTYPE html>
<html>

<head>
  <title>Đăng nhập</title>
</head>

<body>
  <H3>Xuất dữ liệu ra màn hình</H3>
  <div id="data-container"></div>
  <button onclick="getData()">Lấy dữ liệu</button>



  <h3>Chỉnh sửa sản phẩm</h3>
  <div id="edit-form"></div>


  <h3>Thêm sản phẩm mới</h3>
  <button id="showFormButton">Hiển thị Form</button>
  <form id="productForm" style="display: none;">
    <label for="name">Tên sản phẩm:</label>
    <input type="text" id="name" name="name" required><br><br>
    <label for="image">Hình ảnh (URL):</label>
    <input type="file" id="image" name="image" required><br><br>
    <button type="submit">Thêm sản phẩm</button>
  </form>


  <script>
    
    //ĐĂNG NHẬP ĐỂ LẤY TOKEN API (CHỈ DÙNG 1 LẦN VÌ LẦN SAU NÓ LƯU VÀO LOCALSTORAGE RỒI)
    function login() {
      fetch('http://localhost:8080/api/v1/users/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: 'admin@sgu.edu.vn',
          password: '123456',
        }),
      })
        .then(response => response.json())
        .then(data => {
          const accessToken = data.content.access_token;
          //LƯU TOKEN VÀO LOCAL STORAGE
          localStorage.setItem('accessToken', accessToken);
          console.log('Token saved to localStorage:', accessToken);
        })
        .catch(error => {
          console.error('Login failed:', error);
        });
    }


    function getData() {
      // Lấy token từ localStorage
      const accessToken = localStorage.getItem('accessToken');

      // Kiểm tra xem có token trong localStorage hay không
      if (!accessToken) {
        console.error('Token not found in localStorage');
        return;
      }

      fetch('http://localhost:8080/api/v1/categories', {
        // SỬ DỤNG PHƯƠNG THỨC GET ĐỂ LẤY SẢN PHẨM
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          token: accessToken,
        },
      })
        .then(response => response.json())
        .then(data => {
          // NẾU MUỐN TRUY XUẤT ĐẾN THÀNH PHẦN DATA THÌ CỨ .THÀNHPHAN
          console.log('Data gốc: ', data);
          console.log('Data thành phần: ', data.content);

          // Hiển thị dữ liệu trong bảng HTML
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const tbody = document.createElement('tbody');

          // Tạo hàng đầu bảng (header)
          const headerRow = document.createElement('tr');
          headerRow.innerHTML = `
        <th>ID</th>
        <th>Image</th>
        <th>Name</th>
        <th>Xem chi tiết</th>
        <th>Chỉnh sửa</th>
        <th>Xóa</th>
      `;
          thead.appendChild(headerRow);

          // Tạo các hàng dữ liệu (rows)
          data.content.forEach(item => {
            const dataRow = document.createElement('tr');
            dataRow.innerHTML = `
          <td>${item.id}</td>
          <td><img src="${item.image}" alt="${item.name}" style="width: 200px; height: 100px;"></td>
          <td>${item.name}</td>
          <td><button onclick="searchDetailCategoryByID(${item.id})">Xem chi tiết (trong console log)</button></td>
          <td><button onclick="updateCategoryByID(${item.id})">Xem chi tiết (trong console log)</button></td>
          <td><button onclick="deleteCategoryByID(${item.id})">Xóa(trong console log)</button></td>
        `;
            tbody.appendChild(dataRow);
          });

          // Gắn các phần tử vào bảng
          table.appendChild(thead);
          table.appendChild(tbody);

          // Hiển thị bảng trong HTML
          const container = document.getElementById('data-container');
          container.appendChild(table);
        })
        .catch(error => {
          console.error('Failed to fetch data:', error);
        });
    }



    //TÌM KIẾM ĐƠN HÀNG THEO MÃ SẢN PHẨM
    function searchDetailCategoryByID(id) {
      // Lấy token từ localStorage
      const accessToken = localStorage.getItem('accessToken');

      // Kiểm tra xem có token trong localStorage hay không
      if (!accessToken) {
        console.error('Token not found in localStorage');
        return;
      }

      fetch(`http://localhost:8080/api/v1/categories/category/${id}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          token: accessToken,
        },
      })
        .then(response => response.json())
        .then(data => {
          console.log('Kết quả tìm kiếm bằng mã:', data.content);
          return data.content;
          // Xử lý kết quả tìm kiếm đơn hàng ở đây
        })
        .catch(error => {
          console.error('Failed to fetch data:', error);
        });
    }


    function deleteCategoryByID(id) {
      // Lấy token từ localStorage
      const accessToken = localStorage.getItem('accessToken');

      // Kiểm tra xem có token trong localStorage hay không
      if (!accessToken) {
        console.error('Token not found in localStorage');
        return;
      }

      fetch(`http://localhost:8080/api/v1/categories/category/${id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          token: accessToken,
        },
      })
        .then(response => response.json())
        .then(data => {
          console.log('Xóa thành công');
          console.log('Kết quả tìm kiếm bằng mã:', data.content);
          location.reload();
          // Xử lý kết quả tìm kiếm đơn hàng ở đây
        })
        .catch(error => {
          console.error('Failed to fetch data:', error);
        });
    }

    function updateCategoryByID(id) {
  // Lấy token từ localStorage
  const accessToken = localStorage.getItem('accessToken');

  // Kiểm tra xem có token trong localStorage hay không
  if (!accessToken) {
    console.error('Token not found in localStorage');
    return;
  }

  // Gửi yêu cầu GET để tìm kiếm danh mục bằng ID
  fetch(`http://localhost:8080/api/v1/categories/category/${id}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      token: accessToken,
    },
  })
    .then(response => response.json())
    .then(data => {
      // Kiểm tra xem kết quả tìm kiếm có dữ liệu không
      if (!data) {
        console.error('Không tìm thấy danh mục');
        return;
      }

      // Lấy thông tin danh mục từ kết quả tìm kiếm
      const { name, image } = data.content;

      // Tạo form chỉnh sửa và điền thông tin danh mục
      const form = document.createElement('form');

      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'Tên danh mục:';
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = data.content.name;
      form.appendChild(nameLabel);
      form.appendChild(nameInput);

      const imageLabel = document.createElement('label');
      imageLabel.textContent = 'Hình ảnh danh mục:';
      const imageInput = document.createElement('input');
      imageInput.type = 'text';
      imageInput.value = data.content.image;
      form.appendChild(imageLabel);
      form.appendChild(imageInput);

      const updateButton = document.createElement('button');
      updateButton.textContent = 'Chỉnh sửa';
      updateButton.addEventListener('click', () => {
        const updatedData = {
          name: nameInput.value,
          image: imageInput.value
        };
        // Gửi yêu cầu PUT để cập nhật danh mục
        fetch(`http://localhost:8080/api/v1/categories/category/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            token: accessToken,
          },
          body: JSON.stringify(updatedData),
        })
          .then(response => response.json())
          .then(updatedCategory => {
            console.log('Danh mục đã được cập nhật:', updatedCategory);
          })
          .catch(error => {
            console.error('Lỗi khi cập nhật danh mục:', error);
          });
      });
      form.appendChild(updateButton);

      // Hiển thị form trong một phần tử HTML (ví dụ: <div id="edit-form"></div>)
      const formContainer = document.getElementById('edit-form');
      formContainer.innerHTML = '';
      formContainer.appendChild(form);
    })
    .catch(error => {
      console.error('Lỗi khi tìm kiếm danh mục:', error);
    });
}


    const showFormButton = document.getElementById('showFormButton');
    const categoriesForm = document.getElementById('productForm');

    showFormButton.addEventListener('click', function () {
      showFormButton.style.display = 'none'; // Ẩn nút hiển thị form
      categoriesForm.style.display = 'block'; // Hiển thị form
    });


    function convertImageToBase64(file, callback) {
  const reader = new FileReader();

  reader.addEventListener("load", () => {
    callback(reader.result);
  });

  reader.addEventListener("error", () => {
    console.error("Lỗi khi đọc file.");
    callback(null);
  });

  reader.readAsDataURL(file);
}

function addProduct(event) {
  event.preventDefault();

  const nameInput = document.getElementById('name');
  const imageInput = document.getElementById('image');

  const file = imageInput.files[0];

  if (!file) {
    console.error('Không có file được chọn.');
    return;
  }

  convertImageToBase64(file, base64Data => {
    if (!base64Data) {
      console.error('Lỗi khi chuyển đổi hình ảnh.');
      return;
    }

    const newProduct = {
      name: nameInput.value,
      image: base64Data,
    };

    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
      console.error('Token not found in localStorage');
      return;
    }

    fetch('http://localhost:8080/api/v1/categories/category', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'token': accessToken,
      },
      body: JSON.stringify(newProduct)
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Lỗi khi gửi yêu cầu.');
        }
        return response.json();
      })
      .then(data => {
        console.log('Data gốc:', data);
        console.log('Data thành phần:', data.content);
        alert('Thêm sản phẩm thành công');
        location.reload();
      })
      .catch(error => {
        console.error('Lỗi khi gửi yêu cầu:', error);
        alert('Thêm sản phẩm thất bại');
      });
  });
}

const productForm = document.getElementById('productForm');
productForm.addEventListener('submit', addProduct);
    login();

  </script>
</body>

</html>